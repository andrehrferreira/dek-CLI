{"version":3,"sources":["../src/install.js"],"names":["CLIPath","path","resolve","dirname","fs","realpathSync","__filename","PackageJSON","require","join","prompt","inquirer","createPromptModule","registerPrompt","Install","self","packageJSONTemplate","__this","settings","devmode","installDevMode","installedDevMode","frontend","installFrontendFramework","installedWebpack","installWebpack","installedFrontend","installInterval","setInterval","clearInterval","console","log","chalk","green","i18n","__","plugins","length","installPlugins","loadPackageDependencies","then","dependencies","addPackageDependencies","installDependencies","writeFile","JSON","stringify","err","type","name","message","result","install","child","shell","env","process","cwd","stdio","stdin","stdout","stderr","on","exitCode","usageText","replace","cliDevMode","exit","__self","directoryExists","devMode","e","red","webpack","webpackLoaders","WebpackConfigTemplate","writeFileSync","scripts","callback","totalScripts","loadedScripts","forEach","parScript","test","split","dependency","devDependencies","setTimeout","filePath","statSync","isDirectory","argv","h","Help","_","pluginName","index"],"mappings":"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","file":"install.js","sourcesContent":["import fs from \"fs\";\nimport path from \"path\";\nimport npm from \"npm\";\n\nimport 'babel-polyfill';\nimport minimist from \"minimist\";\nimport chalk from \"chalk\";\nimport inquirer from \"inquirer\";\nimport i18n from \"i18n\";\nimport _ from \"lodash\";\nimport gitClone from \"git-clone\";\nimport rimraf from \"rimraf\";\nimport { exec, spawn } from \"child_process\";\n\nimport { plugins, installPlugin } from \"./plugins\";\n\nconst CLIPath = path.resolve(path.dirname(fs.realpathSync(__filename)), \"../\");\nconst PackageJSON = require(path.join(CLIPath, \"package\"));\n\nlet prompt = inquirer.createPromptModule();\ninquirer.registerPrompt('fuzzypath', require('inquirer-fuzzy-path'));\n\nexport class Install{\n    async bootstrap(self, packageJSONTemplate){\n        var __this = this;\n        this.packageJSONTemplate = packageJSONTemplate;\n\n        if(self.settings.devmode)\n            await this.installDevMode(self);\n        else\n            this.installedDevMode = true;\n\n        if(self.settings.frontend != \"none\"){\n            await this.installFrontendFramework(self);\n            this.installedWebpack = true;\n        }\n        else {\n            await this.installWebpack(self);\n            this.installedFrontend = true;\n        }\n\n        var installInterval = setInterval(async () => {\n            if(this.installedDevMode && this.installedWebpack && this.installedFrontend){\n                clearInterval(installInterval);\n                console.log(chalk.green(i18n.__(\"Create package.json ...\")));\n\n                if(self.settings.plugins.length > 0){\n                    await plugins.installPlugins(self.settings.plugins, path.join(self.settings.path, \"src\", \"plugins\"));\n                    plugins.loadPackageDependencies(path.join(self.settings.path, \"src\", \"plugins\"), self.settings.plugins).then((dependencies) => {\n                        __this.addPackageDependencies(dependencies , self.settings, () => {\n                            console.log(chalk.green(i18n.__(\"Install plugins dependencies ...\")));\n                            __this.installDependencies(self);\n                        });\n                    });\n                }\n                else{\n                    this.installDependencies(self);\n                }\n            }\n        }, 1000);\n    }\n\n    installDependencies(self){\n        fs.writeFile(path.join(self.settings.path, \"package.json\"), JSON.stringify(this.packageJSONTemplate, null, 4), async (err) => {\n            prompt([{\n                type: 'confirm',\n                name: 'install',\n                message: i18n.__(\"Would you like to install dependencies via NPM?\"),\n            }]).then(result => {\n                if(result.install){\n                    var child = spawn(\"npm install -D\", {\n                        shell: true,\n                        env: process.env,\n                        cwd: self.settings.path,\n                        stdio: [process.stdin, process.stdout, process.stderr]\n                    });\n\n                    child.on('exit', function (exitCode) {\n                        const usageText = `Project created successfully!\n\nTo start the project in development mode:\n$ cd .${self.settings.path.replace(process.cwd(), \"\")}\n$ ${PackageJSON[\"@dek/scripts\"].cliDevMode}\n$ npm run dev\n`;\n\n                        console.log(usageText);\n                        process.exit(0);\n                    });\n                }\n                else{\n                    const usageText = `Project created successfully!\n\nTo start the project in development mode:\n$ cd .${self.settings.path.replace(process.cwd(), \"\")}\n$ ${PackageJSON[\"@dek/scripts\"].cliDevMode}\n$ npm install --save-dev\n$ npm run dev\n`;\n\n                    console.log(usageText);\n                    process.exit(0);\n                }\n            });\n        });\n    }\n\n    installFrontendFramework(self){\n        var __self = this;\n        this.installedFrontend = false;\n        console.log(chalk.green(i18n.__(\"Install frontend framework ...\")));\n\n        if(this.directoryExists(path.join(self.settings.path, \"public\"))){\n            rimraf(path.join(self.settings.path, \"public\"), () => {\n                var child = spawn(PackageJSON[\"@dek/frontend\"][self.settings.frontend], {\n                    shell: true,\n                    env: process.env,\n                    cwd: self.settings.path,\n                    stdio: [process.stdin, process.stdout, process.stderr]\n                });\n\n                child.on('exit', function (exitCode) {\n                    __self.installedFrontend = true;\n                });\n            });\n        }\n        else{\n            var child = spawn(PackageJSON[\"@dek/frontend\"][self.settings.frontend], {\n                shell: true,\n                env: process.env,\n                cwd: self.settings.path,\n                stdio: [process.stdin, process.stdout, process.stderr]\n            });\n\n            child.on('exit', function (exitCode) {\n                __self.installedFrontend = true;\n            });\n        }\n    }\n\n    installDevMode(self){\n        this.installedDevMode = false;\n        console.log(chalk.green(i18n.__(\"Install dev mode ...\")));\n\n        try{\n            this.addPackageDependencies(PackageJSON[\"@dek/scripts\"].devMode, { cwd: self.settings.path }, () => {\n                this.installedDevMode = true;\n            });\n        } catch(e){\n            console.log(chalk.red(e.message));\n        }\n    }\n\n    installWebpack(self){\n        this.installedWebpack = false;\n        console.log(chalk.green(i18n.__(\"Install Webpack ...\")));\n\n        this.addPackageDependencies([PackageJSON[\"@dek/scripts\"].webpack, PackageJSON[\"@dek/scripts\"].webpackLoaders], { cwd: self.settings.path }, () => {\n            var WebpackConfigTemplate = require(path.join(CLIPath, \"templates\", \"webpack.config.js\"))(self);\n            fs.writeFileSync(path.join(self.settings.path, \"webpack.config.js\"), WebpackConfigTemplate);\n\n            this.installedWebpack = true;\n            return true;\n        });\n    }\n\n    async addPackageDependencies(scripts, settings, callback){\n        var totalScripts = 0, loadedScripts = 0;\n\n        if(typeof scripts == \"string\")\n            scripts = [scripts];\n\n        scripts.forEach((parScript) => {\n            if(/--save-dev/.test(parScript)){\n                parScript = parScript.replace(\"--save-dev\", \"\");\n\n                parScript.split(\" \").forEach((dependency) => {\n                    if(dependency && dependency != \"\")\n                        this.packageJSONTemplate.devDependencies[dependency] = \"latest\";\n                });\n            }\n            else {\n                parScript = parScript.replace(\"--save\", \"\");\n\n                parScript.split(\" \").forEach((dependency) => {\n                    if(dependency && dependency != \"\")\n                        this.packageJSONTemplate.dependencies[dependency] = \"latest\";\n                });\n            }\n        });\n\n        if(typeof callback == \"function\")\n            setTimeout(() => { callback(); }, 1000);\n    }\n\n    directoryExists(filePath){\n        try { return fs.statSync(filePath).isDirectory(); }\n        catch (err) { return false; }\n    }\n\n    Help(){\n        const usageText = `\n  Usage:\n    dek install (with no args, in package dir)\n    dek install <plugin>\n    dek install <git:// url>\n  `\n\n        console.log(usageText)\n    }\n}\n\nexport default async (argv) => {\n    let install = new Install();\n\n    if(argv.h){\n        install.Help();\n    }\n    else if(argv._.length > 1){\n        argv._.forEach(async (pluginName, index) => {\n            if(index != 0)\n                await installPlugin(pluginName);\n        });\n    }\n    else{\n        install.Help();\n    }\n}\n"]}