{"version":3,"sources":["../src/install.js"],"names":["CLIPath","path","resolve","dirname","fs","realpathSync","__filename","PackageJSON","require","join","prompt","inquirer","createPromptModule","registerPrompt","Install","self","packageJSONTemplate","__this","installInterval","setInterval","clearInterval","console","log","chalk","green","i18n","__","settings","plugins","length","installPlugins","loadPackageDependencies","then","dependencies","addPackageDependencies","installDependencies","writeFile","JSON","stringify","err","type","name","message","result","install","child","shell","env","process","cwd","stdio","stdin","stdout","stderr","on","exitCode","usageText","replace","cliDevMode","exit","__self","installedFrontend","directoryExists","frontend","installedDevMode","devMode","e","red","installedWebpack","webpack","webpackLoaders","WebpackConfigTemplate","writeFileSync","scripts","callback","totalScripts","loadedScripts","forEach","parScript","test","split","dependency","devDependencies","setTimeout","filePath","statSync","isDirectory","argv","h","Help","_","pluginsList","map","pluginName","index","push","installPlugin"],"mappings":"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","file":"install.js","sourcesContent":["import '@babel/polyfill/noConflict';\n\nimport fs from \"fs\";\nimport path from \"path\";\nimport npm from \"npm\";\nimport minimist from \"minimist\";\nimport chalk from \"chalk\";\nimport inquirer from \"inquirer\";\nimport i18n from \"i18n\";\nimport _ from \"lodash\";\nimport gitClone from \"git-clone\";\nimport rimraf from \"rimraf\";\nimport series from 'async/series';\nimport { exec, spawn } from \"child_process\";\n\nimport { plugins } from \"./plugins\";\n\nconst CLIPath = path.resolve(path.dirname(fs.realpathSync(__filename)), \"../\");\nconst PackageJSON = require(path.join(CLIPath, \"package\"));\n\nlet prompt = inquirer.createPromptModule();\ninquirer.registerPrompt('fuzzypath', require('inquirer-fuzzy-path'));\n\nexport class Install{\n    async bootstrap(self, packageJSONTemplate){\n        var __this = this;\n        this.packageJSONTemplate = packageJSONTemplate;\n\n        /*if(self.settings.devmode)\n            await this.installDevMode(self);\n        else\n            this.installedDevMode = true;\n\n        if(self.settings.frontend != \"none\"){\n            await this.installFrontendFramework(self);\n            this.installedWebpack = true;\n        }\n        else {\n            await this.installWebpack(self);\n            this.installedFrontend = true;\n        }*/\n\n        var installInterval = setInterval(async () => {\n            //if(this.installedDevMode && this.installedWebpack && this.installedFrontend){\n                clearInterval(installInterval);\n                console.log(chalk.green(i18n.__(\"Create package.json ...\")));\n\n                if(self.settings.plugins.length > 0){\n                    await plugins.installPlugins(self.settings.plugins, path.join(self.settings.path, \"src\", \"plugins\"));\n                    plugins.loadPackageDependencies(path.join(self.settings.path, \"src\", \"plugins\"), self.settings.plugins).then((dependencies) => {\n                        __this.addPackageDependencies(dependencies , self.settings, () => {\n                            console.log(chalk.green(i18n.__(\"Install plugins dependencies ...\")));\n                            __this.installDependencies(self);\n                        });\n                    });\n                }\n                else{\n                    this.installDependencies(self);\n                }\n            //}\n        }, 1000);\n    }\n\n    installDependencies(self){\n        fs.writeFile(path.join(self.settings.path, \"package.json\"), JSON.stringify(this.packageJSONTemplate, null, 4), async (err) => {\n            prompt([{\n                type: 'confirm',\n                name: 'install',\n                message: i18n.__(\"Would you like to install dependencies via NPM?\"),\n            }]).then(result => {\n                if(result.install){\n                    var child = spawn(\"npm install -D\", {\n                        shell: true,\n                        env: process.env,\n                        cwd: self.settings.path,\n                        stdio: [process.stdin, process.stdout, process.stderr]\n                    });\n\n                    child.on('exit', function (exitCode) {\n                        const usageText = `Project created successfully!\n\nTo start the project in development mode:\n$ cd .${self.settings.path.replace(process.cwd(), \"\")}\n$ ${PackageJSON[\"@dek/scripts\"].cliDevMode}\n$ npm run dev\n`;\n\n                        console.log(usageText);\n                        process.exit(0);\n                    });\n                }\n                else{\n                    const usageText = `Project created successfully!\n\nTo start the project in development mode:\n$ cd .${self.settings.path.replace(process.cwd(), \"\")}\n$ ${PackageJSON[\"@dek/scripts\"].cliDevMode}\n$ npm install --save-dev\n$ npm run dev\n`;\n\n                    console.log(usageText);\n                    process.exit(0);\n                }\n            });\n        });\n    }\n\n    installFrontendFramework(self){\n        var __self = this;\n        this.installedFrontend = false;\n        console.log(chalk.green(i18n.__(\"Install frontend framework ...\")));\n\n        if(this.directoryExists(path.join(self.settings.path, \"public\"))){\n            rimraf(path.join(self.settings.path, \"public\"), () => {\n                var child = spawn(PackageJSON[\"@dek/frontend\"][self.settings.frontend], {\n                    shell: true,\n                    env: process.env,\n                    cwd: self.settings.path,\n                    stdio: [process.stdin, process.stdout, process.stderr]\n                });\n\n                child.on('exit', function (exitCode) {\n                    __self.installedFrontend = true;\n                });\n            });\n        }\n        else{\n            var child = spawn(PackageJSON[\"@dek/frontend\"][self.settings.frontend], {\n                shell: true,\n                env: process.env,\n                cwd: self.settings.path,\n                stdio: [process.stdin, process.stdout, process.stderr]\n            });\n\n            child.on('exit', function (exitCode) {\n                __self.installedFrontend = true;\n            });\n        }\n    }\n\n    installDevMode(self){\n        this.installedDevMode = false;\n        console.log(chalk.green(i18n.__(\"Install dev mode ...\")));\n\n        try{\n            this.addPackageDependencies(PackageJSON[\"@dek/scripts\"].devMode, { cwd: self.settings.path }, () => {\n                this.installedDevMode = true;\n            });\n        } catch(e){\n            console.log(chalk.red(e.message));\n        }\n    }\n\n    installWebpack(self){\n        this.installedWebpack = false;\n        console.log(chalk.green(i18n.__(\"Install Webpack ...\")));\n\n        this.addPackageDependencies([PackageJSON[\"@dek/scripts\"].webpack, PackageJSON[\"@dek/scripts\"].webpackLoaders], { cwd: self.settings.path }, () => {\n            var WebpackConfigTemplate = require(path.join(CLIPath, \"templates\", \"webpack.config.js\"))(self);\n            fs.writeFileSync(path.join(self.settings.path, \"webpack.config.js\"), WebpackConfigTemplate);\n\n            this.installedWebpack = true;\n            return true;\n        });\n    }\n\n    async addPackageDependencies(scripts, settings, callback){\n        var totalScripts = 0, loadedScripts = 0;\n\n        if(typeof scripts == \"string\")\n            scripts = [scripts];\n\n        scripts.forEach((parScript) => {\n            if(/--save-dev/.test(parScript)){\n                parScript = parScript.replace(\"--save-dev\", \"\");\n\n                parScript.split(\" \").forEach((dependency) => {\n                    if(dependency && dependency != \"\")\n                        this.packageJSONTemplate.devDependencies[dependency] = \"latest\";\n                });\n            }\n            else {\n                parScript = parScript.replace(\"--save\", \"\");\n\n                parScript.split(\" \").forEach((dependency) => {\n                    if(dependency && dependency != \"\")\n                        this.packageJSONTemplate.dependencies[dependency] = \"latest\";\n                });\n            }\n        });\n\n        if(typeof callback == \"function\")\n            setTimeout(() => { callback(); }, 1000);\n    }\n\n    directoryExists(filePath){\n        try { return fs.statSync(filePath).isDirectory(); }\n        catch (err) { return false; }\n    }\n\n    Help(){\n        const usageText = `\n  Usage:\n    dek install (with no args, in package dir)\n    dek install <plugin>\n    dek install <git:// url>\n  `\n\n        console.log(usageText)\n    }\n}\n\nexport default async (argv) => {\n    let install = new Install();\n\n    if(argv.h){\n        install.Help();\n    }\n    else if(argv._.length > 1){\n        var pluginsList = [];\n\n        _.map(argv._, (pluginName, index) => {\n            pluginsList.push((callback) => {\n                if(index != 0){\n                    plugins.installPlugin(pluginName, null, false).then(() => {\n                        callback();\n                    });\n                }\n                else{\n                    callback();\n                }\n            });\n        });\n\n        series(pluginsList, (err, result) => {\n            process.exit(0);\n        });\n    }\n    else{\n        install.Help();\n    }\n}\n"]}